<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Style-Type" content="text/css" />
  <meta name="generator" content="pandoc" />
  <title></title>
  <style type="text/css">code{white-space: pre;}</style>
  <link rel="stylesheet" href="style.css" type="text/css" />
</head>
<body>
<div id="TOC">
<ul>
<li><a href="#compiling-for-own-machine">Compiling for own machine</a><ul>
<li><a href="#ubuntu">Ubuntu</a></li>
<li><a href="#debian">Debian</a></li>
<li><a href="#fedora">Fedora</a></li>
<li><a href="#osx-macos">OSX / macOS</a></li>
<li><a href="#other">Other</a></li>
</ul></li>
<li><a href="#break-on-panic">Break on panic</a></li>
<li><a href="#break-during-an-infinite-loop">Break during an infinite loop</a></li>
<li><a href="#symlinks-to-the-currently-configured-assignment">Symlinks to the currently configured assignment</a></li>
<li><a href="#gdbinit-that-points-to-the-current-assignment">gdbinit that points to the current assignment</a></li>
<li><a href="#syntastic">Syntastic</a></li>
<li><a href="#ctags">Ctags</a></li>
<li><a href="#run-tests-repeatedly">Run Tests Repeatedly</a></li>
</ul>
</div>
<p>This document is a collection of quality-of-life improvement tips for working with sys161 and os161 in CS 350. It is up to date for the Fall 2016 term. It does not include tips that are already given in course handouts/documents.</p>
<h1 id="compiling-for-own-machine">Compiling for own machine</h1>
<p>The toolchain for os161 and sys161 is ancient. It doesn’t really compile any more on modern versions. The easiest way to get things to compile is to get an old version of a compiler. gcc 4.8 has been reported to work, as well as gcc 4.7. Versions as old as gcc 3.4 were also working.</p>
<p>To use a custom version of gcc, set the <code>CC</code> environment variable before running the configure script. For example, <code>CC=gcc4.8 ./configure blah blah</code> or <code>export CC=gcc4.8</code>. The latter is recommended if you’re going to configure a lot. If all else fails, symlink <code>/usr/bin/gcc</code> to the appropriate version.</p>
<h2 id="ubuntu">Ubuntu</h2>
<p>Luckily, there are packages for old versions of gcc, so</p>
<pre><code>apt install gcc-4.8</code></pre>
<p>should work on trusty to yakkety. If you are on precise, the version of gcc shipped with it is old enough anyway.</p>
<h2 id="debian">Debian</h2>
<p>Debian packages are ancient: jessie is still on 4.8, so you should be fine. Otherwise, future versions (testing, unstable) should have <code>gcc-4.x</code> packages that you can use.</p>
<h2 id="fedora">Fedora</h2>
<p>Fedora 24 and probably others should offer the package <code>compat-gcc-34</code>, so install that with</p>
<pre><code>dnf install compat-gcc-34</code></pre>
<h2 id="osx-macos">OSX / macOS</h2>
<p>The easiest way to get an old version of gcc is with <a href="https://www.macports.org/">macports</a>. Install that, and then</p>
<p><code>port install gcc48</code></p>
<p>There’s probably a way with homebrew as well.</p>
<h2 id="other">Other</h2>
<p>Compiling an old version of gcc from source is actually kinda hard because new versions of gcc don’t compile it anymore! Try to get an old version by some other means. I haven’t been able to compile gcc 4.8 from source successfully on Fedora 24, for example.</p>
<h1 id="break-on-panic">Break on panic</h1>
<p>In <code>os161-1.99/kern/lib/kprintf.c</code>, go to the definition of <code>panic</code> and insert a break instruction.</p>
<pre><code>__asm(&quot;break&quot;);</code></pre>
<p>Sys161 and os161 will handle this and bring up the “waiting for debugger message”, and now you can attach a debugger to figure out precisely where you crashed. This is for when you’re too lazy to add a breakpoint in GDB yourself. For bonus points, you can set a flag at runtime to determine whether or not this is enabled.</p>
<h1 id="break-during-an-infinite-loop">Break during an infinite loop</h1>
<p>If you’re in some sort of loop or deadlock and none of your breakpoints are triggering, you can simply attach a debugger at that point and it will break for you. No need to guess where to put the breakpoint.</p>
<p>If you’re already in the debugger and you want to pause execution, a normal ^C won’t work. You can patch sys161 to respond to a signal such as SIGUSR1 to pause things. This is useful for when you’re already in the debugger and you’re inside an infinite loop.</p>
<p>For a ready-made patch, see <a href="http://www.student.cs.uwaterloo.ca/~s455wang/break_on_sigusr1.patch" class="uri">http://www.student.cs.uwaterloo.ca/~s455wang/break_on_sigusr1.patch</a>. Copy that to the top level of the sys161 source tree and apply it with <code>git apply break_on_sigusr1.patch</code>. You do not need to have a git repository to apply the patch.</p>
<h1 id="symlinks-to-the-currently-configured-assignment">Symlinks to the currently configured assignment</h1>
<p>This is a prerequisite for the next two sections.</p>
<p>Much like how the makefiles include a symlink from <code>kernel</code> to the current assignment, eg. <code>kernel-ASST0</code>, it’s useful to create a symlink from <code>kern/compile/CURRENT</code> to the current compile directory. Patch <code>kern/conf/config</code> with the patch located at <a href="https://www.student.cs.uwaterloo.ca/~s455wang/config-link.patch" class="uri">https://www.student.cs.uwaterloo.ca/~s455wang/config-link.patch</a>.</p>
<h1 id="gdbinit-that-points-to-the-current-assignment">gdbinit that points to the current assignment</h1>
<p>With the previous tip in place, let your .gdbinit file be</p>
<pre><code>dir ../os161-1.99/kern/compile/CURRENT
target remote unix:.sockets/gdb</code></pre>
<p>Now you no longer have to modify gdbinit for every assignment.</p>
<h1 id="syntastic">Syntastic</h1>
<p><a href="https://github.com/scrooloose/syntastic/">Syntastic</a> is a syntax checker for vim. Requires the symlink tip to be set up.</p>
<p>Syntastic can be set up with some effort. First, you need a <code>.syntastic_c_config</code> file at the top level of the source tree with the following contents:</p>
<pre><code>-Iuser/include
-Ikern/include
-Ikern/compile/CURRENT
-Ikern/compile/CURRENT/includelinks
-Ikern/dev
-std=gnu99
-Wall
-Wwrite-strings
-Wmissing-prototypes
-nostdinc
-D_KERNEL
-DUW</code></pre>
<p>These are ripped straight from the makefiles. Without these, syntastic will complain loudly about not being able to find just about every header file.</p>
<p>If you are only going to use syntastic for cs350, you can afford to be lazy and put <code>let g:syntastic_c_compiler = &quot;cs350-gcc&quot;</code> in your .vimrc. This is necessary because of all the MIPS assembly that would otherwise show up as errors when checking.</p>
<p>If you use syntastic for checking other non-cs350 C code, install the <a href="https://github.com/thinca/vim-localrc">localrc</a> plugin and place the above setting in your <code>.local.vimrc</code> as per the plugin documentation.</p>
<p>I believe that this is one of the most useful tips as it saves you a lot of time trying to fix compilation errors.</p>
<h1 id="ctags">Ctags</h1>
<p>According to the <a href="https://www.student.cs.uwaterloo.ca/~cs350/common/os161-faq.html">CS350 os161 FAQ</a> the student.cs environment is supposed to have Exuberant Ctags, but it doesn’t. You can <a href="http://ctags.sourceforge.net/">install it yourself</a> in your home dir and then you can use ctags. The only keybindings I really use are <code>Ctrl-]</code> to go to the definition of a tag, and <code>Ctrl-T</code> to go up the tag stack.</p>
<h1 id="run-tests-repeatedly">Run Tests Repeatedly</h1>
<p>Due to some quirkiness with how sys161 takes input, simply piping output to <code>sys161</code> makes it hang. The alternative is to send long strings on the command line. There’s a limit for how long your arguments can be but you won’t reach it even with 400 tests or so. Here’s a <a href="/static/repeat-test.sh">script</a> for it <a href="/static/repeat-test.html">(preview)</a>.</p>
<p>This is most useful in assignment 3.</p>
</body>
</html>
